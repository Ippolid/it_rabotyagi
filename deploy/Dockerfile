# --- Этап 1: Сборка приложения ---
FROM golang:1.24.5-alpine AS builder

# Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# Копируем файлы зависимостей и загружаем их
# Это кэширует слой с зависимостями, ускоряя последующие сборки
COPY go.mod go.sum ./
RUN go mod download

# Копируем весь исходный код проекта
COPY . .

# Собираем приложение.
# CGO_ENABLED=0 создает статически скомпилированный бинарный файл.
RUN CGO_ENABLED=0 GOOS=linux go build -o /app/app ./cmd/app/main.go

# --- Этап 2: Создание финального образа ---
FROM alpine:latest

WORKDIR /app

# Копируем скомпилированный бинарный файл из этапа сборки
COPY --from=builder /app/app .

# Копируем директорию web с фронтендом из этапа сборки
# Ваш код (r.Static("/web", "./web")) ожидает, что эта папка будет рядом с исполняемым файлом
COPY --from=builder /app/web ./web

COPY deploy/.env .
# Открываем порт, на котором работает приложение (по умолчанию 8080)
EXPOSE 8080

# Указываем команду для запуска приложения при старте контейнера
ENTRYPOINT ["./app"]
