services:
  # 1. Сервис базы данных PostgreSQL
  pg-local:
    image: postgres:17-alpine
    container_name: it_rabotyagi_postgres
    restart: always
    environment:
      POSTGRES_DB: ${PG_DATABASE_NAME}
      POSTGRES_USER: ${PG_USER}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
    ports:
      - "${PG_PORT}:5432" # Пробрасывает порт БД на хост (например, 54321:5432)
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - it_rabotyagi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PG_USER} -d ${PG_DATABASE_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 2. Сервис для миграций (если у вас есть migration.Dockerfile)
  # Этот сервис запустится, применит миграции и остановится.
  migrator-local:
    build:
      context: ../..
      dockerfile: devops/docker/migration.Dockerfile
    container_name: it_rabotyagi_migrator
    depends_on:
      pg-local:
        condition: service_healthy
    environment:
      # Указываем хост БД для мигратора
      - DB_HOST=pg-local
      # Передаем остальные переменные для подключения к БД
      - PG_DATABASE_NAME=${PG_DATABASE_NAME}
      - PG_USER=${PG_USER}
      - PG_PASSWORD=${PG_PASSWORD}
      - MIGRATION_DIR=${MIGRATION_DIR}
    networks:
      - it_rabotyagi-network

  # 3. Сервис основного приложения
  app:
    build:
      context: ../../backend # Контекст сборки - папка backend
      dockerfile: ../devops/docker/Dockerfile # Путь к Dockerfile относительно контекста
    container_name: it_rabotyagi_app
    restart: always
    ports:
      - "${SERVER_PORT:-8080}:8080" # Пробрасываем порт для доступа к API и Swagger
    environment:
      - DATABASE_URL=postgres://${PG_USER}:${PG_PASSWORD}@pg-local:5432/${PG_DATABASE_NAME}?sslmode=disable
      - JWT_SECRET=${JWT_SECRET:-your-secret-key-change-in-production}
      - SERVER_PORT=8080
      - HTTP_HOST=0.0.0.0
      - LOGGER_LEVEL=info
    depends_on:
      pg-local:
        condition: service_healthy
      migrator-local:
        condition: service_completed_successfully
    networks:
      - it_rabotyagi-network
#
#  # 4. Nginx - веб-сервер для статики и reverse proxy
#  nginx:
#    image: nginx:alpine
#    container_name: it_rabotyagi_nginx
#    restart: always
#    ports:
#      - "${SERVER_PORT:-8080}:80" # Пробрасываем порт наружу
#    volumes:
#      - ../web:/usr/share/nginx/html:ro # Монтируем статические файлы (readonly)
#      - ./nginx.conf:/etc/nginx/nginx.conf:ro # Конфигурация nginx (главный файл!)
#    depends_on:
#      - app
#    networks:
#      - it_rabotyagi-network

# Определяем общую сеть для взаимодействия сервисов
networks:
  it_rabotyagi-network:
    driver: bridge

# Определяем том для хранения данных PostgreSQL
volumes:
  postgres_data:
